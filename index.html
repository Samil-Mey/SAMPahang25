<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Program Sekolah Angkat Madani (SAM)</title>
    <!-- Memuatkan Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuatkan Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Icon Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .content-container {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .sidebar-link {
            display: block;
            padding: 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s, color 0.3s;
            color: #374151; /* gray-700 */
        }
        .sidebar-link:hover {
            background-color: #F3F4F6; /* gray-100 */
        }
        .sidebar-link.active {
            background-color: #3B82F6; /* blue-500 */
            color: white;
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 5rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide number input spinners */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
        }
        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            text-align: left;
            font-size: 14px;
        }
        .data-table thead th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #475569;
        }
        .data-table tbody tr:nth-child(even) {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white p-4 shadow-lg flex flex-col">
            <div class="flex items-center mb-8">
                <i class="fas fa-school-flag text-3xl text-blue-600"></i>
                <h1 class="text-xl font-bold text-gray-800 ml-3">Sistem SAM</h1>
            </div>
            <nav class="space-y-2">
                <a href="#" id="nav-allocation" class="sidebar-link active"><i class="fas fa-file-invoice-dollar fa-fw mr-3"></i>Borang Laporan</a>
                <a href="#" id="nav-analysis" class="sidebar-link"><i class="fas fa-chart-pie fa-fw mr-3"></i>Analisis & Data</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            
            <!-- PAGE: Borang Peruntukan -->
            <div id="page-allocation" class="page-content">
                <div class="content-container max-w-4xl mx-auto p-8">
                    <h2 class="text-2xl font-bold mb-1 text-gray-800">Laporan Program Sekolah Angkat Madani (SAM)</h2>
                    <p class="mb-6 text-gray-600">Sila isikan maklumat peruntukan di bawah. Medan bertanda (*) adalah wajib.</p>
                    <form id="allocation-form" class="space-y-6">
                        <input type="hidden" id="kod-sekolah" name="Kod Sekolah">
                        <input type="hidden" id="form-action" name="action" value="create">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="ppd" class="block text-sm font-medium text-gray-700">PPD (*)</label>
                                <select id="ppd" name="PPD" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="" disabled selected>-- Sila Pilih PPD --</option>
                                    <option value="Bentong">Bentong</option>
                                    <option value="Bera">Bera</option>
                                    <option value="Cameron Highlands">Cameron Highlands</option>
                                    <option value="Jerantut">Jerantut</option>
                                    <option value="Kuantan">Kuantan</option>
                                    <option value="Lipis">Lipis</option>
                                    <option value="Maran">Maran</option>
                                    <option value="Pekan">Pekan</option>
                                    <option value="Raub">Raub</option>
                                    <option value="Rompin">Rompin</option>
                                    <option value="Temerloh">Temerloh</option>
                                </select>
                            </div>
                            <div>
                                <label for="sekolah" class="block text-sm font-medium text-gray-700">Sekolah (*)</label>
                                <select id="sekolah" name="Sekolah" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" disabled>
                                    <option value="" disabled selected>-- Sila Pilih PPD Dahulu --</option>
                                </select>
                            </div>
                        </div>
                        <div>
                           <label for="agensi" class="block text-sm font-medium text-gray-700">Agensi (*)</label>
                           <input type="text" id="agensi" name="Agensi" required class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" placeholder="Akan diisi secara automatik" readonly>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="peruntukan-diluluskan" class="block text-sm font-medium text-gray-700">Peruntukan Diluluskan (RM) (*)</label>
                                <input type="number" step="0.01" id="peruntukan-diluluskan" name="Peruntukan Diluluskan (RM)" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Cth: 100000">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Status Peruntukan</label>
                                <div class="mt-2 flex items-center space-x-6">
                                    <label class="flex items-center"><input type="radio" name="Status Peruntukan" value="Belum Terima" checked class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-2 text-sm text-gray-800">Belum Terima</span></label>
                                    <label class="flex items-center"><input type="radio" name="Status Peruntukan" value="Telah Terima" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-2 text-sm text-gray-800">Telah Terima</span></label>
                                </div>
                            </div>
                            <div id="tarikh-terima-container" class="hidden">
                                <label for="tarikh-terima" class="block text-sm font-medium text-gray-700">Tarikh Terima</label>
                                <input type="date" id="tarikh-terima" name="Tarikh Terima" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Senarai Aset / Peralatan</label>
                            <div id="asset-list" class="mt-2 space-y-3">
                                <!-- Baris aset akan ditambah di sini oleh JavaScript -->
                            </div>
                            <button type="button" id="add-asset-btn" class="mt-3 text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors"><i class="fas fa-plus-circle mr-2"></i>Tambah Aset</button>
                        </div>
                        <div>
                            <label for="catatan" class="block text-sm font-medium text-gray-700">Catatan</label>
                            <textarea id="catatan" name="Catatan" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Sebarang maklumat tambahan..."></textarea>
                        </div>
                        <div class="pt-4">
                            <button type="submit" id="submit-allocation-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Hantar Laporan</button>
                        </div>
                    </form>
                    <div id="allocation-form-message" class="mt-4 text-center"></div>
                </div>
            </div>

            <!-- PAGE: Password Prompt -->
            <div id="page-password" class="page-content hidden h-full flex items-center justify-center">
                 <div class="content-container max-w-sm mx-auto p-8">
                     <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Akses Terhad</h2>
                     <p class="text-center text-gray-600 mb-6">Sila masukkan kata laluan untuk melihat halaman analisis.</p>
                     <form id="password-form">
                         <label for="password" class="block text-sm font-medium text-gray-700">Kata Laluan</label>
                         <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                         <button type="submit" class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Masuk</button>
                     </form>
                     <p id="password-error" class="text-red-500 text-center mt-4 text-sm"></p>
                 </div>
            </div>


            <!-- PAGE: Analisis Data -->
            <div id="page-analysis" class="page-content hidden">
                <div class="content-container !max-w-7xl mx-auto p-8">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Papan Pemuka Analisis SAM</h2>
                     </div>
                     <div id="dashboard-loader" class="hidden"><div class="loader"></div></div>

                     <!-- Filters -->
                     <div class="flex flex-wrap items-center gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                         <div>
                             <label for="filter-ppd" class="block text-sm font-medium text-gray-700">Tapis PPD:</label>
                             <select id="filter-ppd" class="mt-1 block w-full md:w-56 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                 <option value="all">Semua PPD</option>
                             </select>
                         </div>
                         <div>
                             <label for="filter-sekolah" class="block text-sm font-medium text-gray-700">Tapis Sekolah:</label>
                             <select id="filter-sekolah" class="mt-1 block w-full md:w-64 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" disabled>
                                 <option value="all">Semua Sekolah</option>
                             </select>
                         </div>
                         <div class="self-end">
                             <button id="reset-filters-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Set Semula</button>
                         </div>
                     </div>
                     
                     <div id="dashboard-content" class="hidden">
                         <!-- Key Metrics -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <div class="bg-blue-100 p-6 rounded-lg"><h3 class="text-gray-600">Jumlah Peruntukan Diluluskan</h3><p id="total-approved" class="text-3xl font-bold text-blue-800 mt-2">RM 0.00</p></div>
                            <div class="bg-green-100 p-6 rounded-lg"><h3 class="text-gray-600">Jumlah Laporan Diterima</h3><p id="total-allocations" class="text-3xl font-bold text-green-800 mt-2">0</p></div>
                            <div class="bg-purple-100 p-6 rounded-lg"><h3 class="text-gray-600">Peratusan Telah Terima</h3><p id="percent-complete" class="text-3xl font-bold text-purple-800 mt-2">0%</p></div>
                        </div>
                        
                        <!-- School Status Lists -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="font-bold text-lg text-gray-700 mb-4 flex items-center"><i class="fas fa-hourglass-half text-yellow-500 mr-3"></i>Sekolah Belum Terima</h3>
                                <ul id="list-not-received" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow">
                                <h3 class="font-bold text-lg text-gray-700 mb-4 flex items-center"><i class="fas fa-check-circle text-green-500 mr-3"></i>Sekolah Telah Terima</h3>
                                <ul id="list-received" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                            <div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-lg text-gray-700 mb-4">Peruntukan mengikut PPD</h3><canvas id="allocation-by-ppd-chart"></canvas></div>
                            <div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-lg text-gray-700 mb-4">Pecahan Aset/Peralatan</h3><canvas id="asset-breakdown-chart"></canvas></div>
                        </div>

                        <!-- Data Table -->
                        <div>
                             <h3 class="font-bold text-lg text-gray-700 mb-4">Semua Data Laporan</h3>
                             <div class="overflow-x-auto bg-white rounded-lg shadow">
                                 <table class="data-table">
                                     <thead>
                                         <tr>
                                             <th>Kod Sekolah</th>
                                             <th>PPD</th>
                                             <th>Sekolah</th>
                                             <th>Agensi</th>
                                             <th>Peruntukan (RM)</th>
                                             <th>Status</th>
                                             <th>Tarikh Terima</th>
                                             <th>Aset/Peralatan</th>
                                             <th>Catatan</th>
                                         </tr>
                                     </thead>
                                     <tbody id="data-table-body">
                                         <!-- Data rows will be inserted here by JavaScript -->
                                     </tbody>
                                 </table>
                             </div>
                        </div>
                     </div>
                </div>
            </div>

        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- GANTI DENGAN URL GOOGLE APPS SCRIPT ANDA ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxl-1nmdQd9czGLTXxmeUQXdC_EaRCgXDm7JJ9E1RzyMOqh6ja5G-adf_dMWLUkB0-Z/exec';
    const ADMIN_PASSWORD = 'P123';

    const navLinks = {
        allocation: document.getElementById('nav-allocation'),
        analysis: document.getElementById('nav-analysis'),
    };
    const pages = {
        allocation: document.getElementById('page-allocation'),
        analysis: document.getElementById('page-analysis'),
        password: document.getElementById('page-password'),
    };
    
    // --- Pangkalan Data Sekolah SAM ---
    const schoolData = {
        'Bentong': [
            { name: 'SMK KARAK', kod: 'CEE0016', agensi: 'TENAGA NASIONAL BERHAD' },
            { name: 'SMK KHAI MUN', kod: 'CEB0021', agensi: 'AXIATA FOUNDATION' },
            { name: 'SK BUKIT PLATU', kod: 'CBA0019', agensi: 'AXIATA FOUNDATION' },
            { name: 'SMK SULAIMAN', kod: 'CEE0018', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK TELEMONG', kod: 'CEE0017', agensi: 'BURSA MALAYSIA BERHAD' },
            { name: 'SMK KETARI', kod: 'CEE0017', agensi: 'MAYBANK' }
        ],
        'Bera': [
            { name: 'SMK SERI BERA', kod: 'CEA0053', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK MENGKARAK', kod: 'CEA0045', agensi: 'PERMODALAN NASIONAL BERHAD' },
            { name: 'SMK TRIANG 3', kod: 'CEA0060', agensi: 'YAYASAN PETRONAS' }
        ],
        'Cameron Highlands': [
            { name: 'SMK SULTAN AHMAD SHAH', kod: 'CEE1036', agensi: 'YAYASAN PETRONAS' }
        ],
        'Jerantut': [
            { name: 'SK GINTONG', kod: 'CBA2033', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK INDERAPURA', kod: 'CEA2043', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK KOTA GELANGGI 2', kod: 'CEA2041', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK PULAU TAWAR', kod: 'CBA2015', agensi: 'TENAGA NASIONAL BERHAD' },
            { name: 'SK TEMPINI', kod: 'CBA2048', agensi: 'YAYASAN TM' },
            { name: 'SMK JERANTUT', kod: 'CEA2030', agensi: 'TENAGA NASIONAL BERHAD' }
        ],
        'Kuantan': [
            { name: 'SK (FELDA) BUKIT KUANTAN', kod: 'CBA4039', agensi: 'SIME DARBY' },
            { name: 'SK (FELDA) BUKIT SAGU 1', kod: 'CBA4042', agensi: 'SIME DARBY' },
            { name: 'SK BALOK', kod: 'CBA4017', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK CHEROK PALOH', kod: 'CBA4061', agensi: 'UMPSAS' },
            { name: 'SK FAKEH ABD SAMAD', kod: 'CBA4027', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK KEMPADANG', kod: 'CBA4051', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK SUNGAI ISAP MURNI', kod: 'CBA4081', agensi: 'TENAGA NASIONAL BERHAD' },
            { name: 'SK SUNGAI KARANG', kod: 'CBA4022', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK ABDUL RAHMAN TALIB', kod: 'CEB4048', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK AIR PUTIH', kod: 'CEA4076', agensi: 'TENAGA NASIONAL BERHAD' },
            { name: 'SMK BUKIT RANGIN', kod: 'CEA4085', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK PAYA BESAR', kod: 'CEA4065', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK PELINDUNG', kod: 'CEA4080', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK SERI PANCHING', kod: 'CEA4088', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK SUNGAI ISAP', kod: 'CEA4083', agensi: 'TENAGA NASIONAL BERHAD' },
            { name: 'SMK TANAH PUTEH', kod: 'CEB4049', agensi: 'BANK RAKYAT' },
            { name: 'SMK TENGKU AFZAN', kod: 'CEB4050', agensi: 'YAYASAN PETRONAS' }
        ],
        'Lipis': [
            { name: 'SK CLIFFORD', kod: 'CBB3035', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK KUALA LANAR', kod: 'CBA3021', agensi: 'TENAGA NASIONAL BERHAD' },
            { name: 'SK WAN IBRAHIM', kod: 'CBA3045', agensi: 'TENAGA NASIONAL BERHAD' },
            { name: 'SMK CHUNG HWA', kod: 'CEB3041', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK ORANG KAYA HAJI', kod: 'CEA3038', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK PADANG TENGKU', kod: 'CEA3037', agensi: 'YAYASAN PETRONAS' }
        ],
        'Maran': [
            { name: 'SMK (FELDA) JENGKA PUSAT', kod: 'CEA5056', agensi: 'SIME DARBY' },
            { name: 'SK JENGKA PUSAT 2', kod: 'CBA5026', agensi: 'SIME DARBY' },
            { name: 'SMK JENGKA 2', kod: 'CEA5067', agensi: 'SIME DARBY' },
            { name: 'SK JENGKA 18', kod: 'CBA5043', agensi: 'SIME DARBY' },
            { name: 'SMK MARAN', kod: 'CEA5055', agensi: 'TENAGA NASIONAL BERHAD' }
        ],
        'Pekan': [
            { name: 'KOLEJ VOKASIONAL PEKAN', kod: 'CHA6002', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK (FELDA) CHINI TIMUR 1', kod: 'CBA6024', agensi: 'SIME DARBY' },
            { name: 'SK INDERA SHAHBANDAR', kod: 'CBB6056', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK KUALA PEKAN', kod: 'CBA6007', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK PEKAN JAYA', kod: 'CBA6039', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK SERI TERENTANG', kod: 'CBA6032', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK AHMAD', kod: 'CEE6061', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK PERAMU JAYA', kod: 'CEA6019', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK TENGKU ABDULLAH', kod: 'CEA6014', agensi: 'TENAGA NASIONAL BERHAD' }
        ],
        'Raub': [
            { name: 'SMK (P) METHODIST', kod: 'CEB7054', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK RAUB JAYA', kod: 'CBA7071', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK DATO SHAHBANDAR HUSSEIN', kod: 'CEA7058', agensi: 'YAYASAN PETRONAS' }
        ],
        'Rompin': [
            { name: 'SK MUKUT', kod: 'CBA8031', agensi: 'YAYASAN TM' },
            { name: 'SMK MUADZAM SHAH', kod: 'CEA8032', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK PERANTAU DAMAI', kod: 'CEA8021', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK ROMPIN', kod: 'CBA8001', agensi: 'MAYBANK' }
        ],
        'Temerloh': [
            { name: 'SMK TEMERLOH', kod: 'CEA7063', agensi: 'PERMODALAN NASIONAL BERHAD' },
            { name: 'SMK LANCHANG', kod: 'CEA7073', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK ABU BAKAR', kod: 'CEE7080', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK DATUK BAHAMAN', kod: 'CEA7072', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK MENTAKAB (P)', kod: 'CBB7067', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK SERI BAHAGIA', kod: 'CBA7068', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK PENDERAS', kod: 'CBO7094', agensi: 'YAYASAN TM' },
            { name: 'SJKT LADANG MENTAKAB', kod: 'CBD7090', agensi: 'YAYASAN PETRONAS' }
        ]
    };
    
    let isAuthenticated = false;
    let samData = [];
    let charts = {};

    const allocationForm = document.getElementById('allocation-form');
    const assetListContainer = document.getElementById('asset-list');
    const addAssetBtn = document.getElementById('add-asset-btn');
    const ppdSelect = document.getElementById('ppd');
    const sekolahSelect = document.getElementById('sekolah');
    const agensiInput = document.getElementById('agensi');
    const kodSekolahInput = document.getElementById('kod-sekolah');
    const formActionInput = document.getElementById('form-action');
    const submitBtn = document.getElementById('submit-allocation-btn');
    const formMessage = document.getElementById('allocation-form-message');
    const peruntukanInput = document.getElementById('peruntukan-diluluskan');
    const catatanInput = document.getElementById('catatan');
    const tarikhContainer = document.getElementById('tarikh-terima-container');
    const tarikhInput = document.getElementById('tarikh-terima');
    const passwordForm = document.getElementById('password-form');
    const passwordError = document.getElementById('password-error');
    const filterPPD = document.getElementById('filter-ppd');
    const filterSekolah = document.getElementById('filter-sekolah');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');

    let assetCounter = 0;

    // --- Pengurusan Navigasi & Auth ---
    function setActivePage(pageId) {
        Object.values(pages).forEach(page => page.classList.add('hidden'));
        Object.values(navLinks).forEach(link => link.classList.remove('active'));
        pages[pageId].classList.remove('hidden');
        if (pageId === 'analysis' || pageId === 'password') {
            navLinks.analysis.classList.add('active');
        } else {
            navLinks.allocation.classList.add('active');
        }
    }

    navLinks.allocation.addEventListener('click', (e) => { e.preventDefault(); setActivePage('allocation'); });
    navLinks.analysis.addEventListener('click', (e) => {
        e.preventDefault();
        if (isAuthenticated) {
            setActivePage('analysis');
            loadDashboardData();
        } else {
            setActivePage('password');
        }
    });

    passwordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('password').value;
        if (password === ADMIN_PASSWORD) {
            isAuthenticated = true;
            passwordError.textContent = '';
            setActivePage('analysis');
            loadDashboardData();
        } else {
            passwordError.textContent = 'Kata laluan salah. Sila cuba lagi.';
        }
    });

    // --- Borang Peruntukan ---
    function createAssetRow(item = '', quantity = '') {
        assetCounter++;
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-3 asset-row';
        div.innerHTML = `
            <span class="text-sm font-medium text-gray-500 w-6">${assetCounter}.</span>
            <input type="text" placeholder="Jenis Aset / Peralatan" value="${item}" class="asset-name flex-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <input type="number" placeholder="Kuantiti" value="${quantity}" class="asset-quantity w-32 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <button type="button" class="remove-asset-btn text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>
        `;
        assetListContainer.appendChild(div);
        div.querySelector('.remove-asset-btn').addEventListener('click', () => {
            div.remove();
            reindexAssets();
        });
    }

    function reindexAssets() {
        assetCounter = 0;
        assetListContainer.querySelectorAll('.asset-row span').forEach(span => {
            assetCounter++;
            span.textContent = `${assetCounter}.`;
        });
    }

    function clearReportDetails() {
        peruntukanInput.value = '';
        catatanInput.value = '';
        agensiInput.value = '';
        kodSekolahInput.value = '';
        
        const statusRadio = document.querySelector('input[name="Status Peruntukan"][value="Belum Terima"]');
        if (statusRadio) statusRadio.checked = true;
        
        tarikhContainer.classList.add('hidden');
        tarikhInput.value = '';
        
        assetListContainer.innerHTML = '';
        assetCounter = 0;
        createAssetRow();
        
        formMessage.textContent = '';
        submitBtn.textContent = 'Hantar Laporan';
        submitBtn.className = 'w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500';
        formActionInput.value = 'create';
    }

    async function fetchAndPopulateRecord(kodSekolah) {
        if (!kodSekolah) return;
        formMessage.textContent = 'Menyemak data sedia ada...';
        formMessage.className = 'text-gray-600 mt-4 text-center';
        try {
            const url = `${GOOGLE_SCRIPT_URL}?action=getRecord&kodSekolah=${kodSekolah}`;
            const response = await fetch(url);
            const result = await response.json();
            if (result.found) {
                const data = result.data;
                formMessage.textContent = 'Data sedia ada ditemui. Anda boleh mengemas kini maklumat di bawah.';
                formMessage.className = 'text-blue-600 mt-4 text-center';
                peruntukanInput.value = data['Peruntukan Diluluskan (RM)'];
                catatanInput.value = data['Catatan'];
                document.querySelector(`input[name="Status Peruntukan"][value="${data['Status Peruntukan']}"]`).checked = true;
                if (data['Status Peruntukan'] === 'Telah Terima') {
                    tarikhContainer.classList.remove('hidden');
                    if (data['Tarikh Terima']) {
                       tarikhInput.value = new Date(data['Tarikh Terima']).toISOString().split('T')[0];
                    }
                }
                assetListContainer.innerHTML = '';
                assetCounter = 0;
                const assets = JSON.parse(data['Senarai Aset Peralatan'] || '[]');
                if(assets.length > 0) {
                    assets.forEach(asset => createAssetRow(asset.item, asset.kuantiti));
                } else {
                    createAssetRow();
                }
                formActionInput.value = 'update';
                submitBtn.textContent = 'Kemaskini Laporan';
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            } else {
                formMessage.textContent = 'Tiada data sedia ada. Sila masukkan laporan baharu.';
                formMessage.className = 'text-green-600 mt-4 text-center';
            }
        } catch (error) {
            formMessage.textContent = 'Ralat semasa menyemak data.';
            formMessage.className = 'text-red-600 mt-4 text-center';
        }
    }
    
    addAssetBtn.addEventListener('click', () => createAssetRow());
    
    ppdSelect.addEventListener('change', function() {
        const selectedPPD = this.value;
        sekolahSelect.innerHTML = '<option value="" disabled selected>-- Sila Pilih Sekolah --</option>';
        sekolahSelect.disabled = true;
        
        clearReportDetails(); // Clear details but keep PPD selection

        if (schoolData[selectedPPD]) {
            schoolData[selectedPPD].forEach(school => {
                const option = document.createElement('option');
                option.value = school.name;
                option.textContent = school.name;
                sekolahSelect.appendChild(option);
            });
            sekolahSelect.disabled = false;
        }
    });
    
    sekolahSelect.addEventListener('change', function() {
        clearReportDetails(); // Clear previous school's details

        const selectedPPD = ppdSelect.value;
        const selectedSchoolName = this.value;

        if (schoolData[selectedPPD]) {
            const schoolInfo = schoolData[selectedPPD].find(s => s.name === selectedSchoolName);
            if (schoolInfo) {
                agensiInput.value = schoolInfo.agensi;
                kodSekolahInput.value = schoolInfo.kod;
                fetchAndPopulateRecord(schoolInfo.kod);
            }
        }
    });
    
    document.querySelectorAll('input[name="Status Peruntukan"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'Telah Terima') {
                tarikhContainer.classList.remove('hidden');
            } else {
                tarikhContainer.classList.add('hidden');
                tarikhInput.value = '';
            }
        });
    });

    allocationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menghantar...';
        formMessage.textContent = '';
        const assets = [];
        document.querySelectorAll('.asset-row').forEach(row => {
            const name = row.querySelector('.asset-name').value.trim();
            const quantity = row.querySelector('.asset-quantity').value.trim();
            if (name && quantity) {
                assets.push({ item: name, kuantiti: quantity });
            }
        });
        const formData = new FormData(this);
        const dataObject = {};
        formData.forEach((value, key) => dataObject[key] = value);
        dataObject['Senarai Aset Peralatan'] = JSON.stringify(assets);
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataObject) })
            .then(res => res.json())
            .then(data => {
                const actionText = formActionInput.value === 'update' ? 'dikemaskini' : 'dihantar';
                if(data.result === 'success') {
                    formMessage.textContent = `Data laporan berjaya ${actionText}.`;
                    formMessage.className = 'text-green-600 mt-4 text-center';
                    if(formActionInput.value === 'create') {
                       sekolahSelect.value = '';
                       clearReportDetails();
                    }
                } else { throw new Error(data.message || 'Unknown error'); }
            })
            .catch(error => {
                formMessage.textContent = `Ralat: ${error.message}`;
                formMessage.className = 'text-red-600 mt-4 text-center';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = formActionInput.value === 'update' ? 'Kemaskini Laporan' : 'Hantar Laporan';
            });
    });

    // --- Analisis Data ---
    function formatAssetsForDisplay(assetString) {
        if (!assetString) return '';
        try {
            if (assetString.trim().startsWith('[')) {
                const assets = JSON.parse(assetString);
                if (Array.isArray(assets) && assets.length > 0) {
                    return assets.map(a => `${a.kuantiti}x ${a.item}`).join('\n');
                }
                return '-';
            }
            return assetString;
        } catch (e) { return assetString; }
    }

    async function loadDashboardData() {
        const loader = document.getElementById('dashboard-loader');
        const content = document.getElementById('dashboard-content');
        loader.classList.remove('hidden');
        content.classList.add('hidden');
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            if (!response.ok) throw new Error('Gagal memuatkan data dari server.');
            const allData = await response.json();
            samData = allData.filter(item => item.hasOwnProperty('Peruntukan Diluluskan (RM)'));
            populateFilters();
            applyFiltersAndRedraw();
            loader.classList.add('hidden');
            content.classList.remove('hidden');
        } catch (error) {
            loader.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
        }
    }
    
    function populateFilters() {
        const ppds = Object.keys(schoolData);
        filterPPD.innerHTML = '<option value="all">Semua PPD</option>';
        ppds.forEach(ppd => {
            const option = document.createElement('option');
            option.value = ppd;
            option.textContent = ppd;
            filterPPD.appendChild(option);
        });
    }

    filterPPD.addEventListener('change', () => {
        const selectedPPD = filterPPD.value;
        filterSekolah.innerHTML = '<option value="all">Semua Sekolah</option>';
        if (selectedPPD === 'all') {
            filterSekolah.disabled = true;
        } else {
            schoolData[selectedPPD].forEach(school => {
                const option = document.createElement('option');
                option.value = school.name;
                option.textContent = school.name;
                filterSekolah.appendChild(option);
            });
            filterSekolah.disabled = false;
        }
        applyFiltersAndRedraw();
    });

    filterSekolah.addEventListener('change', applyFiltersAndRedraw);

    resetFiltersBtn.addEventListener('click', () => {
        filterPPD.value = 'all';
        filterSekolah.innerHTML = '<option value="all">Semua Sekolah</option>';
        filterSekolah.disabled = true;
        applyFiltersAndRedraw();
    });
    
    function applyFiltersAndRedraw() {
        let filteredData = [...samData];
        const selectedPPD = filterPPD.value;
        const selectedSekolah = filterSekolah.value;

        if (selectedPPD !== 'all') {
            filteredData = filteredData.filter(item => item.PPD === selectedPPD);
        }
        if (selectedSekolah !== 'all') {
            filteredData = filteredData.filter(item => item.Sekolah === selectedSekolah);
        }
        
        updateDashboard(filteredData);
        populateDataTable(filteredData);
    }

    function updateDashboard(data) {
        const totalApproved = data.reduce((sum, item) => sum + (parseFloat(item['Peruntukan Diluluskan (RM)']) || 0), 0);
        const allocationsReceived = data.filter(item => item['Status Peruntukan'] === 'Telah Terima').length;
        const percentComplete = data.length > 0 ? (allocationsReceived / data.length) * 100 : 0;
        document.getElementById('total-approved').textContent = `RM ${totalApproved.toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('total-allocations').textContent = data.length;
        document.getElementById('percent-complete').textContent = `${percentComplete.toFixed(1)}%`;
        populateSchoolStatusLists(data);
        updatePPDChart(data);
        updateAssetBreakdownChart(data);
    }

    function populateSchoolStatusLists(data) {
        const listReceived = document.getElementById('list-received');
        const listNotReceived = document.getElementById('list-not-received');
        listReceived.innerHTML = '';
        listNotReceived.innerHTML = '';
        data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'text-sm text-gray-700';
            li.textContent = `${item.Sekolah} (${item.PPD})`;
            if(item['Status Peruntukan'] === 'Telah Terima') {
                listReceived.appendChild(li);
            } else {
                listNotReceived.appendChild(li);
            }
        });
        if(listReceived.innerHTML === '') listReceived.innerHTML = '<li class="text-sm text-gray-400">Tiada sekolah.</li>';
        if(listNotReceived.innerHTML === '') listNotReceived.innerHTML = '<li class="text-sm text-gray-400">Tiada sekolah.</li>';
    }
    
    function populateDataTable(data) {
        const tableBody = document.getElementById('data-table-body');
        tableBody.innerHTML = '';
        if(data.length === 0){
             tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-4">Tiada data untuk dipaparkan.</td></tr>';
             return;
        }
        data.forEach(item => {
            const row = document.createElement('tr');
            const formattedDate = item['Tarikh Terima'] ? new Date(item['Tarikh Terima']).toLocaleDateString('ms-MY') : '-';
            row.innerHTML = `
                <td>${item['Kod Sekolah'] || ''}</td>
                <td>${item.PPD || ''}</td>
                <td>${item.Sekolah || ''}</td>
                <td>${item.Agensi || ''}</td>
                <td>${(parseFloat(item['Peruntukan Diluluskan (RM)']) || 0).toLocaleString('ms-MY')}</td>
                <td>${item['Status Peruntukan'] || ''}</td>
                <td>${formattedDate}</td>
                <td class="whitespace-pre-wrap">${formatAssetsForDisplay(item['Senarai Aset Peralatan'])}</td>
                <td>${item.Catatan || ''}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updatePPDChart(data) {
        const ctx = document.getElementById('allocation-by-ppd-chart').getContext('2d');
        const dataByPPD = data.reduce((acc, item) => {
            const ppd = item['PPD'];
            if (!acc[ppd]) { acc[ppd] = 0; }
            acc[ppd] += parseFloat(item['Peruntukan Diluluskan (RM)']) || 0;
            return acc;
        }, {});
        const labels = Object.keys(dataByPPD).sort();
        const values = labels.map(ppd => dataByPPD[ppd]);
        if (charts.ppd) charts.ppd.destroy();
        charts.ppd = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [ { label: 'Jumlah Peruntukan (RM)', data: values, backgroundColor: 'rgba(54, 162, 235, 0.6)' } ] },
            options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    function updateAssetBreakdownChart(data) {
        const ctx = document.getElementById('asset-breakdown-chart').getContext('2d');
        const assetTotals = {};
        data.forEach(row => {
            try {
                if(row['Senarai Aset Peralatan'] && row['Senarai Aset Peralatan'].trim().startsWith('[')) {
                    const assets = JSON.parse(row['Senarai Aset Peralatan']);
                    assets.forEach(asset => {
                        const itemName = asset.item.trim();
                        const quantity = parseInt(asset.kuantiti, 10);
                        if(itemName && !isNaN(quantity)) {
                           assetTotals[itemName] = (assetTotals[itemName] || 0) + quantity;
                        }
                    });
                }
            } catch(e) { /* Abaikan jika JSON tidak sah */ }
        });
        const labels = Object.keys(assetTotals).sort();
        const values = labels.map(label => assetTotals[label]);
        if (charts.asset) charts.asset.destroy();
        charts.asset = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Jumlah Kuantiti', data: values, backgroundColor: 'rgba(75, 192, 192, 0.6)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 }] },
            options: { indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    // Initialize
    setActivePage('allocation');
    createAssetRow();
});
</script>

</body>
</html>

