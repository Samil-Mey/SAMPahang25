<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Program Sekolah Angkat Madani (SAM)</title>
    <!-- Memuatkan Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuatkan Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Icon Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Tema Korporat */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; /* slate-100 */
        }
        .sidebar {
            background-color: #1e293b; /* slate-800 */
            color: #cbd5e1; /* slate-300 */
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            color: #cbd5e1; /* slate-300 */
            font-weight: 500;
        }
        .sidebar-link:hover {
            background-color: #334155; /* slate-700 */
            color: white;
        }
        .sidebar-link.active {
            background-color: #2563eb; /* blue-600 */
            color: white;
            font-weight: 600;
        }
        .content-container {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .loader {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 5rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide number input spinners */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        input[type='number'] { -moz-appearance: textfield; }
        
        /* Table styles */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 15px; border: 1px solid #e2e8f0; text-align: left; font-size: 14px; }
        .data-table thead th { background-color: #f8fafc; font-weight: 600; color: #334155; }
        .data-table tbody tr:nth-child(even) { background-color: #f8fafc; }

        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-sent { background-color: #dcfce7; color: #166534; }
        .status-pending { background-color: #fef9c3; color: #854d0e; }
    </style>
</head>
<body class="bg-slate-100">

    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-64 sidebar p-4 flex flex-col flex-shrink-0">
            <div class="flex items-center justify-center py-4 mb-6">
                <img src="imej1.png" alt="Logo JPN" class="h-20 w-auto">
            </div>
            <nav class="space-y-2">
                <a href="#" id="nav-allocation" class="sidebar-link active"><i class="fas fa-file-alt fa-fw mr-3 w-5 text-center"></i>Borang Laporan</a>
                <a href="#" id="nav-checklist" class="sidebar-link"><i class="fas fa-tasks fa-fw mr-3 w-5 text-center"></i>Senarai Semak</a>
                <a href="#" id="nav-analysis" class="sidebar-link"><i class="fas fa-chart-pie fa-fw mr-3 w-5 text-center"></i>Analisis & Data</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-y-auto">
            <div class="p-8 flex-grow">
                <!-- PAGE: Borang Peruntukan -->
                <div id="page-allocation" class="page-content">
                    <img src="imej2.png" alt="Header Program Sekolah Angkat Madani" class="w-full h-auto rounded-lg mb-8 shadow-md">
                    <div class="content-container max-w-4xl mx-auto p-8">
                        <h2 class="text-2xl font-bold mb-1 text-slate-800">Laporan Program Sekolah Angkat Madani (SAM)</h2>
                        <p class="mb-6 text-slate-600">Sila isikan maklumat peruntukan di bawah. Medan bertanda (*) adalah wajib.</p>
                        <form id="allocation-form" class="space-y-6">
                            <input type="hidden" id="kod-sekolah" name="Kod Sekolah">
                            <input type="hidden" id="form-action" name="action" value="create">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="ppd" class="block text-sm font-medium text-slate-700">PPD (*)</label>
                                    <select id="ppd" name="PPD" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                                </div>
                                <div>
                                    <label for="sekolah" class="block text-sm font-medium text-slate-700">Sekolah (*)</label>
                                    <select id="sekolah" name="Sekolah" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" disabled></select>
                                </div>
                            </div>
                            <div>
                               <label for="agensi" class="block text-sm font-medium text-slate-700">Agensi (*)</label>
                               <input type="text" id="agensi" name="Agensi" required class="mt-1 block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md shadow-sm" placeholder="Akan diisi secara automatik" readonly>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="peruntukan-diluluskan" class="block text-sm font-medium text-slate-700">Peruntukan Diluluskan (RM) (*)</label>
                                    <input type="text" id="peruntukan-diluluskan" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Cth: 100,000">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Status Peruntukan</label>
                                <div class="mt-2 flex items-center space-x-6">
                                    <label class="flex items-center"><input type="radio" name="Status Peruntukan" value="Belum Terima" checked class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"> <span class="ml-2 text-sm text-slate-800">Belum Terima</span></label>
                                    <label class="flex items-center"><input type="radio" name="Status Peruntukan" value="Telah Terima" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"> <span class="ml-2 text-sm text-slate-800">Telah Terima</span></label>
                                </div>
                            </div>

                            <!-- Container for fields shown only when "Telah Terima" is selected -->
                            <div id="received-details-container" class="hidden space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                                    <div>
                                        <label for="peruntukan-dibelanjakan" class="block text-sm font-medium text-slate-700">Peruntukan Dibelanjakan (RM)</label>
                                        <input type="text" id="peruntukan-dibelanjakan" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Cth: 75,000">
                                    </div>
                                    <div>
                                        <label for="baki-peruntukan" class="block text-sm font-medium text-slate-700">Baki Peruntukan (RM)</label>
                                        <input type="text" id="baki-peruntukan" class="mt-1 block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md shadow-sm" readonly>
                                    </div>
                                </div>
                                <div>
                                    <label for="tarikh-terima" class="block text-sm font-medium text-slate-700">Tarikh Terima</label>
                                    <input type="date" id="tarikh-terima" name="Tarikh Terima" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>


                            <div>
                                <label class="block text-sm font-medium text-slate-700">Senarai Aset / Peralatan</label>
                                <div id="asset-list" class="mt-2 space-y-3"></div>
                                <button type="button" id="add-asset-btn" class="mt-3 text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors"><i class="fas fa-plus-circle mr-2"></i>Tambah Aset</button>
                            </div>
                            <div>
                                <label for="catatan" class="block text-sm font-medium text-slate-700">Catatan</label>
                                <textarea id="catatan" name="Catatan" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Sebarang maklumat tambahan..."></textarea>
                            </div>
                            <div class="pt-4">
                                <button type="submit" id="submit-allocation-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Hantar Laporan</button>
                            </div>
                        </form>
                        <div id="allocation-form-message" class="mt-4 text-center"></div>
                    </div>
                </div>
                
                <!-- PAGE: Senarai Semak -->
                <div id="page-checklist" class="page-content hidden">
                    <img src="imej2.png" alt="Header Program Sekolah Angkat Madani" class="w-full h-auto rounded-lg mb-8 shadow-md">
                     <div class="content-container !max-w-7xl mx-auto p-8">
                         <h2 class="text-3xl font-bold text-slate-800 mb-6">Senarai Semak Penghantaran Laporan</h2>
                         <div id="checklist-loader" class="hidden"><div class="loader"></div></div>
                         <div class="flex flex-wrap items-center gap-4 mb-6 bg-slate-50 p-4 rounded-lg">
                             <div>
                                 <label for="checklist-filter-ppd" class="block text-sm font-medium text-slate-700">Tapis PPD:</label>
                                 <select id="checklist-filter-ppd" class="mt-1 block w-full md:w-56 px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                             </div>
                             <div class="self-end">
                                 <button id="checklist-reset-filters-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-600 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Set Semula</button>
                             </div>
                         </div>
                         <div id="checklist-content" class="hidden">
                            <div class="overflow-x-auto bg-white rounded-lg shadow">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Kod Sekolah</th>
                                            <th>PPD</th>
                                            <th>Sekolah</th>
                                            <th>Status Laporan</th>
                                        </tr>
                                    </thead>
                                    <tbody id="checklist-table-body"></tbody>
                                </table>
                            </div>
                         </div>
                    </div>
                </div>

                <!-- PAGE: Password Prompt -->
                <div id="page-password" class="page-content hidden h-full flex items-center justify-center">
                     <div class="content-container max-w-sm mx-auto p-8">
                         <h2 class="text-2xl font-bold mb-4 text-slate-800 text-center">Akses Terhad</h2>
                         <p class="text-center text-slate-600 mb-6">Sila masukkan kata laluan untuk melihat halaman analisis.</p>
                         <form id="password-form">
                             <label for="password" class="block text-sm font-medium text-slate-700">Kata Laluan</label>
                             <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                             <button type="submit" class="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Masuk</button>
                         </form>
                         <p id="password-error" class="text-red-500 text-center mt-4 text-sm"></p>
                     </div>
                </div>

                <!-- PAGE: Analisis Data -->
                <div id="page-analysis" class="page-content hidden">
                    <img src="imej2.png" alt="Header Program Sekolah Angkat Madani" class="w-full h-auto rounded-lg mb-8 shadow-md">
                    <div class="content-container !max-w-7xl mx-auto p-8">
                         <h2 class="text-3xl font-bold text-slate-800 mb-6">Papan Pemuka Analisis SAM</h2>
                         <div id="dashboard-loader" class="hidden"><div class="loader"></div></div>
                         <div class="flex flex-wrap items-center gap-4 mb-6 bg-slate-50 p-4 rounded-lg">
                             <div>
                                 <label for="filter-ppd" class="block text-sm font-medium text-slate-700">Tapis PPD:</label>
                                 <select id="filter-ppd" class="mt-1 block w-full md:w-56 px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                             </div>
                             <div>
                                 <label for="filter-sekolah" class="block text-sm font-medium text-slate-700">Tapis Sekolah:</label>
                                 <select id="filter-sekolah" class="mt-1 block w-full md:w-64 px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" disabled></select>
                             </div>
                             <div class="self-end">
                                 <button id="reset-filters-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-600 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Set Semula</button>
                             </div>
                         </div>
                         <div id="dashboard-content" class="hidden">
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                <div class="bg-blue-100 p-6 rounded-lg"><h3 class="text-slate-600">Jumlah Diluluskan</h3><p id="total-approved" class="text-3xl font-bold text-blue-800 mt-2">RM 0.00</p></div>
                                <div class="bg-orange-100 p-6 rounded-lg"><h3 class="text-slate-600">Jumlah Dibelanjakan</h3><p id="total-spent" class="text-3xl font-bold text-orange-800 mt-2">RM 0.00</p></div>
                                <div class="bg-red-100 p-6 rounded-lg"><h3 class="text-slate-600">Baki Perbelanjaan</h3><p id="total-balance" class="text-3xl font-bold text-red-800 mt-2">RM 0.00</p></div>
                                <div class="bg-green-100 p-6 rounded-lg"><h3 class="text-slate-600">Jumlah Laporan Diterima</h3><p id="total-allocations" class="text-3xl font-bold text-green-800 mt-2">0</p></div>                                <div class="bg-teal-100 p-6 rounded-lg"><h3 class="text-slate-600">Peratus Perbelanjaan</h3><p id="percent-spent" class="text-3xl font-bold text-teal-800 mt-2">0%</p></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                                <div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-lg text-slate-700 mb-4 flex items-center"><i class="fas fa-hourglass-half text-yellow-500 mr-3"></i>Sekolah Belum Terima</h3><ul id="list-not-received" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul></div>
                                <div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-lg text-slate-700 mb-4 flex items-center"><i class="fas fa-check-circle text-green-500 mr-3"></i>Sekolah Telah Terima</h3><ul id="list-received" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul></div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                                <div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-lg text-slate-700 mb-4">Peruntukan mengikut PPD</h3><canvas id="allocation-by-ppd-chart"></canvas></div>
                                <div class="bg-white p-6 rounded-lg shadow"><h3 class="font-bold text-lg text-slate-700 mb-4">Pecahan Aset/Peralatan</h3><canvas id="asset-breakdown-chart"></canvas></div>
                            </div>
                            <div>
                                 <h3 class="font-bold text-lg text-slate-700 mb-4">Semua Data Laporan</h3>
                                 <div class="overflow-x-auto bg-white rounded-lg shadow">
                                     <table class="data-table">
                                         <thead>
                                             <tr>
                                                 <th>Kod Sekolah</th>
                                                 <th>PPD</th>
                                                 <th>Sekolah</th>
                                                 <th>Agensi</th>
                                                 <th>Peruntukan Diluluskan (RM)</th>
                                                 <th>Peruntukan Dibelanjakan (RM)</th>
                                                 <th>Baki Peruntukan (RM)</th>
                                                 <th>Status</th>
                                                 <th>Tarikh Terima</th>
                                                 <th>Aset/Peralatan</th>
                                                 <th>Catatan</th>
                                             </tr>
                                         </thead>
                                         <tbody id="data-table-body"></tbody>
                                     </table>
                                 </div>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
            
            <footer class="text-center py-4 mt-auto">
                <p class="text-sm text-slate-500">Sektor Pengurusan Sekolah © 2025</p>
                <p class="text-sm text-slate-500">Jabatan Pendidikan Negeri Pahang</p>
            </footer>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- GANTI DENGAN URL GOOGLE APPS SCRIPT ANDA ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpzCJIh288hyO3SOdgNaF8U-o7TNC6xGnZH00w8WSTiZbuqaH03liucHjZt-wr7sSb/exec';
    const ADMIN_PASSWORD = 'P123';

    // All elements references from previous script are maintained
    const navLinks = {
        allocation: document.getElementById('nav-allocation'),
        checklist: document.getElementById('nav-checklist'),
        analysis: document.getElementById('nav-analysis'),
    };
    const pages = {
        allocation: document.getElementById('page-allocation'),
        checklist: document.getElementById('page-checklist'),
        analysis: document.getElementById('page-analysis'),
        password: document.getElementById('page-password'),
    };
    
   // --- Pangkalan Data Sekolah SAM (DIKEMASKINI MENGIKUT PDF) ---
    const schoolData = {
        'BENTONG': [
            { name: 'SMK KARAK', kod: 'CEE0016', agensi: 'TENAGA NASIONAL BERHAD' },
            { name: 'SMK KHAI MUN', kod: 'CEB0021', agensi: 'AXIATA FOUNDATION' },
            { name: 'SK BUKIT PLATU', kod: 'CBA0019', agensi: 'AXIATA FOUNDATION' },
            { name: 'SMK SULAIMAN', kod: 'CEE0018', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK TELEMONG', kod: 'CEB0017', agensi: 'BURSA MALAYSIA BERHAD' },
            { name: 'SMK (LKTP) KG SERTIK', kod: 'CEA0015', agensi: 'GENTING MALAYSIA BHD' },
            { name: 'SK (FELDA) SG KEMAHAL', kod: 'CBA0021', agensi: 'GENTING MALAYSIA BHD' },
            { name: 'SK SUNGAI DUA', kod: 'CBA0006', agensi: 'MYKASIH FOUNDATION' },
            { name: 'SK LEBU', kod: 'CBA0002', agensi: 'JABATAN PERDANA MENTERI' }
        ],
        'CAMERON HIGHLANDS': [
            { name: 'SK LEMOI (JHEOA)', kod: 'CBA1003', agensi: 'SIME DARBY BERHAD' }
        ],
        'JERANTUT': [
            { name: 'SK KG PAGI', kod: 'CBA2023', agensi: 'YAYASAN HASANAH' },
            { name: 'SK MERTING', kod: 'CBA2021', agensi: 'YAYASAN HASANAH' },
            { name: 'SK KUALA SAT', kod: 'CBA2024', agensi: 'KEMENTERIAN SUMBER ASLI DAN KELESTARIAN ALAM' },
            { name: 'SK TANAH ROM', kod: 'CBA2006', agensi: 'JABATAN PERDANA MENTERI' },
            { name: 'SMK KUALA TEMBELING', kod: 'CEA2030', agensi: 'KEMENTERIAN PERPADUAN NEGARA' },
            { name: 'SK KUALA TAHAN', kod: 'CBA2022', agensi: 'MYKASIH FOUNDATION' },
            { name: 'SK PASIR DURIAN', kod: 'CBA2019', agensi: 'JABATAN PERDANA MENTERI' }
        ],
        'KUANTAN': [
            { name: 'SMK TANJUNG LUMPUR', kod: 'CEA4074', agensi: 'YAYASAN UEM' },
            { name: 'SK BUNUT RENDANG', kod: 'CBA4106', agensi: 'YAYASAN UEM' },
            { name: 'SK TOK SERA', kod: 'CBA4092', agensi: 'YAYASAN UEM' },
            { name: 'SK TERUNTUM', kod: 'CBA4001', agensi: 'YAYASAN UEM' },
            { name: 'SK PELINDUNG', kod: 'CBA4107', agensi: 'YAYASAN UEM' },
            { name: 'SMK BUKIT SAGU', kod: 'CEA4097', agensi: 'YAYASAN UEM' },
            { name: 'SMK TELUK CHEMPEDAK', kod: 'CEA4093', agensi: 'YAYASAN UEM' },
            { name: 'SK SUNGAI ULAR', kod: 'CBA4005', agensi: 'IJM CORPORATION BERHAD' },
            { name: 'SK BESERAH', kod: 'CBA4003', agensi: 'KEMENTERIAN PEMBANGUNAN KERAJAAN TEMPATAN' },
            { name: 'SK CHEROK PALOH', kod: 'CBA4017', agensi: 'KEMENTERIAN PENDIDIKAN TINGGI' },
            { name: 'SK WIRA', kod: 'CBA4090', agensi: 'KEMENTERIAN SUMBER ASLI DAN KELESTARIAN ALAM' },
            { name: 'SMK SUNGAI BAGİNG', kod: 'CEA4091', agensi: 'KEMENTERIAN DALAM NEGERI' },
            { name: 'SK PENGKALAN TENTERA', kod: 'CBB4030', agensi: 'LEMBAGA TABUNG ANGKATAN TENTERA (LTAT)' },
            { name: 'SK SUNGAI KARANG', kod: 'CBA4004', agensi: 'JABATAN PERDANA MENTERI' }
        ],
        'LIPIS': [
            { name: 'SMK SETIA WANGSA', kod: 'CEB3038', agensi: 'SD GUTHRIE' },
            { name: 'SMK AGAMA KUALA LIPIS', kod: 'CRA3001', agensi: 'BANK RAKYAT' },
            { name: 'SK KUALA KOYAN (JHEOA)', kod: 'CBA3056', agensi: 'MYKASIH FOUNDATION' },
            { name: 'SK LUBOK KULIT', kod: 'CBA3022', agensi: 'KEMENTERIAN PEMBANGUNAN KERAJAAN TEMPATAN' },
            { name: 'SK KG KELEDEK', kod: 'CBA3004', agensi: 'JABATAN PERDANA MENTERI' }
        ],
        'MARAN': [
            { name: 'SK ULU LUIT', kod: 'CBA9002', agensi: 'TENAGA NASIONAL BERHAD' },
            { name: 'SMK MARAN 2', kod: 'CEA9164', agensi: 'YAYASAN UEM' },
            { name: 'SK (FELDA) JENGKA 19', kod: 'CBA9139', agensi: 'JABATAN PERDANA MENTERI' },
            { name: 'SK SENTOSA', kod: 'CBA9142', agensi: 'MALAYSIA RAIL LINK SDN BHD (MRL)' }
        ],
        'PEKAN': [
            { name: 'SMK PERAMU JAYA', kod: 'CEA5079', agensi: 'BANK ISLAM' },
            { name: 'SK TEMAI', kod: 'CBA5029', agensi: 'KEMENTERIAN PERALIHAN TENAGA DAN TRANSFORMASI AIR' },
            { name: 'SK PERMATANG KELEDANG', kod: 'CBA5023', agensi: 'MYKASIH FOUNDATION' },
            { name: 'SK TASIK CINI PEKAN (JHEOA)', kod: 'CBA5086', agensi: 'MYKASIH FOUNDATION' },
            { name: 'SK TANJUNG BATU', kod: 'CBA5013', agensi: 'YAYASAN TM' }
        ],
        'RAUB': [
            { name: 'SMK MAHMUD', kod: 'CEB6026', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK DATO SHAHBANDAR HUSSAIN', kod: 'CEB6027', agensi: 'BURSA MALAYSIA BERHAD' },
            { name: 'SK SATAK', kod: 'CBA6026', agensi: 'MYKASIH FOUNDATION' }
        ],
        'ROMPIN': [
            { name: 'SMK SERI ROMPIN', kod: 'CEA8025', agensi: 'YAYASAN UEM' },
            { name: 'SMK SUNGAI PUTERI', kod: 'CEA8028', agensi: 'YAYASAN UEM' },
            { name: 'SMK ROMPIN', kod: 'CEA8017', agensi: 'YAYASAN UEM' },
            { name: 'SMK PONTIAN JAYA', kod: 'CEA8030', agensi: 'YAYASAN UEM' },
            { name: 'SMK TANJUNG GEMOK', kod: 'CEA8019', agensi: 'YAYASAN UEM' },
            { name: 'SMK SELENDANG', kod: 'CEA8029', agensi: 'YAYASAN UEM' },
            { name: 'SMK TEKEK', kod: 'CEA8022', agensi: 'YAYASAN TM' },
            { name: 'SK TEKEK', kod: 'CBA8009', agensi: 'YAYASAN TM' },
            { name: 'SK JUARA', kod: 'CBA8032', agensi: 'YAYASAN TM' },
            { name: 'SK MUKUT', kod: 'CBA8031', agensi: 'YAYASAN TM' },
            { name: 'SMK MUADZAM SHAH', kod: 'CEA8032', agensi: 'YAYASAN PETRONAS' },
            { name: 'SMK PERANTAU DAMAI', kod: 'CEA8021', agensi: 'YAYASAN PETRONAS' },
            { name: 'SK ROMPIN', kod: 'CBA8001', agensi: 'MAYBANK' }
        ],
        'TEMERLOH': [
            { name: 'SMK TEMERLOH', kod: 'CEA7063', agensi: 'PERMODALAN NASIONAL BERHAD' },
            { name: 'SMK LANCHANG', kod: 'CEA7073', agensi: 'YAYASAN PETRONAS' },
            { name: 'SJK (TAMIL) LDG MENTAKAB', kod: 'CBD7091', agensi: 'SD GUTHRIE' },
            { name: 'SMK SEBERANG TEMERLOH', kod: 'CEA7160', agensi: 'TENAGA NASIONAL BERHAD' }
        ]
    };
    
    let isAuthenticated = false;
    let samData = [];
    let fullChecklistData = [];
    let charts = {};

    const allocationForm = document.getElementById('allocation-form');
    const assetListContainer = document.getElementById('asset-list');
    const addAssetBtn = document.getElementById('add-asset-btn');
    const ppdSelect = document.getElementById('ppd');
    const sekolahSelect = document.getElementById('sekolah');
    const agensiInput = document.getElementById('agensi');
    const kodSekolahInput = document.getElementById('kod-sekolah');
    const formActionInput = document.getElementById('form-action');
    const submitBtn = document.getElementById('submit-allocation-btn');
    const formMessage = document.getElementById('allocation-form-message');
    const peruntukanInput = document.getElementById('peruntukan-diluluskan');
    const peruntukanDibelanjakanInput = document.getElementById('peruntukan-dibelanjakan');
    const bakiPeruntukanInput = document.getElementById('baki-peruntukan');
    const catatanInput = document.getElementById('catatan');
    const receivedDetailsContainer = document.getElementById('received-details-container');
    const tarikhInput = document.getElementById('tarikh-terima');
    const passwordForm = document.getElementById('password-form');
    const passwordError = document.getElementById('password-error');
    
    const filterPPD = document.getElementById('filter-ppd');
    const filterSekolah = document.getElementById('filter-sekolah');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');

    const checklistFilterPPD = document.getElementById('checklist-filter-ppd');
    const checklistResetFiltersBtn = document.getElementById('checklist-reset-filters-btn');
    const checklistTableBody = document.getElementById('checklist-table-body');

    let assetCounter = 0;

    function populatePPDDropdown(dropdownElement) {
        const ppds = Object.keys(schoolData);
        dropdownElement.innerHTML = '<option value="" disabled selected>-- Sila Pilih PPD --</option>';
        ppds.forEach(ppd => {
            const option = document.createElement('option');
            option.value = ppd;
            option.textContent = ppd;
            dropdownElement.appendChild(option);
        });
    }

    function setActivePage(pageId) {
        Object.values(pages).forEach(page => page.classList.add('hidden'));
        Object.values(navLinks).forEach(link => link.classList.remove('active'));
        
        const pageToShow = pages[pageId];
        if(pageToShow) pageToShow.classList.remove('hidden');

        const linkToActivate = navLinks[pageId];
        if(linkToActivate) linkToActivate.classList.add('active');
        
        if (pageId === 'password') {
            navLinks.analysis.classList.add('active');
        }
    }

    navLinks.allocation.addEventListener('click', (e) => { e.preventDefault(); setActivePage('allocation'); });
    
    navLinks.checklist.addEventListener('click', (e) => {
        e.preventDefault();
        setActivePage('checklist');
        loadChecklistData();
    });

    navLinks.analysis.addEventListener('click', (e) => {
        e.preventDefault();
        if (isAuthenticated) {
            setActivePage('analysis');
            loadDashboardData();
        } else {
            setActivePage('password');
        }
    });

    passwordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('password').value;
        if (password === ADMIN_PASSWORD) {
            isAuthenticated = true;
            passwordError.textContent = '';
            setActivePage('analysis');
            loadDashboardData();
        } else {
            passwordError.textContent = 'Kata laluan salah. Sila cuba lagi.';
        }
    });

    function createAssetRow(item = '', quantity = '') {
        assetCounter++;
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-3 asset-row';
        div.innerHTML = `
            <span class="text-sm font-medium text-slate-500 w-6">${assetCounter}.</span>
            <input type="text" placeholder="Jenis Aset / Peralatan" value="${item}" class="asset-name flex-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <input type="number" placeholder="Kuantiti" value="${quantity}" class="asset-quantity w-32 px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            <button type="button" class="remove-asset-btn text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>
        `;
        assetListContainer.appendChild(div);
        div.querySelector('.remove-asset-btn').addEventListener('click', () => {
            div.remove();
            reindexAssets();
        });
    }

    function reindexAssets() {
        assetCounter = 0;
        assetListContainer.querySelectorAll('.asset-row span').forEach(span => {
            assetCounter++;
            span.textContent = `${assetCounter}.`;
        });
    }

    function clearReportDetails() {
        peruntukanInput.value = '';
        peruntukanDibelanjakanInput.value = '';
        bakiPeruntukanInput.value = '';
        catatanInput.value = '';
        agensiInput.value = '';
        kodSekolahInput.value = '';
        const statusRadio = document.querySelector('input[name="Status Peruntukan"][value="Belum Terima"]');
        if (statusRadio) statusRadio.checked = true;
        receivedDetailsContainer.classList.add('hidden');
        tarikhInput.value = '';
        assetListContainer.innerHTML = '';
        assetCounter = 0;
        createAssetRow();
        formMessage.textContent = '';
        submitBtn.textContent = 'Hantar Laporan';
        submitBtn.className = 'w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500';
        formActionInput.value = 'create';
    }

    function calculateBalance() {
        const approved = parseFloat(peruntukanInput.value.replace(/,/g, '')) || 0;
        const spent = parseFloat(peruntukanDibelanjakanInput.value.replace(/,/g, '')) || 0;
        const balance = approved - spent;
        bakiPeruntukanInput.value = balance.toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    async function fetchAndPopulateRecord(kodSekolah) {
        if (!kodSekolah) return;
        formMessage.textContent = 'Menyemak data sedia ada...';
        formMessage.className = 'text-slate-600 mt-4 text-center';
        try {
            const url = `${GOOGLE_SCRIPT_URL}?action=getRecord&kodSekolah=${kodSekolah}`;
            const response = await fetch(url);
            const result = await response.json();
            if (result.found) {
                const data = result.data;
                formMessage.textContent = 'Data sedia ada ditemui. Anda boleh mengemas kini maklumat di bawah.';
                formMessage.className = 'text-blue-600 mt-4 text-center';
                peruntukanInput.value = parseFloat(data['Peruntukan Diluluskan (RM)'] || 0).toLocaleString('ms-MY');
                catatanInput.value = data['Catatan'];
                
                const status = data['Status Peruntukan'];
                document.querySelector(`input[name="Status Peruntukan"][value="${status}"]`).checked = true;

                if (status === 'Telah Terima') {
                    receivedDetailsContainer.classList.remove('hidden');
                    if (data['Tarikh Terima']) {
                       tarikhInput.value = new Date(data['Tarikh Terima']).toISOString().split('T')[0];
                    }
                    peruntukanDibelanjakanInput.value = parseFloat(data['Peruntukan Dibelanjakan (RM)'] || 0).toLocaleString('ms-MY');
                } else {
                    receivedDetailsContainer.classList.add('hidden');
                    peruntukanDibelanjakanInput.value = '';
                }
                
                calculateBalance(); // Calculate balance after populating

                assetListContainer.innerHTML = '';
                assetCounter = 0;
                const assets = JSON.parse(data['Senarai Aset Peralatan'] || '[]');
                if(assets.length > 0) {
                    assets.forEach(asset => createAssetRow(asset.item, asset.kuantiti));
                } else {
                    createAssetRow();
                }

                formActionInput.value = 'update';
                submitBtn.textContent = 'Kemaskini Laporan';
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            } else {
                formMessage.textContent = 'Tiada data sedia ada. Sila masukkan laporan baharu.';
                formMessage.className = 'text-green-600 mt-4 text-center';
            }
        } catch (error) {
            formMessage.textContent = 'Ralat semasa menyemak data.';
            formMessage.className = 'text-red-600 mt-4 text-center';
        }
    }
    
    addAssetBtn.addEventListener('click', () => createAssetRow());
    
    ppdSelect.addEventListener('change', function() {
        const selectedPPD = this.value;
        sekolahSelect.innerHTML = '<option value="" disabled selected>-- Sila Pilih Sekolah --</option>';
        sekolahSelect.disabled = true;
        clearReportDetails();
        if (schoolData[selectedPPD]) {
            schoolData[selectedPPD].forEach(school => {
                const option = document.createElement('option');
                option.value = school.name;
                option.textContent = school.name;
                sekolahSelect.appendChild(option);
            });
            sekolahSelect.disabled = false;
        }
    });
    
    sekolahSelect.addEventListener('change', function() {
        clearReportDetails();
        const selectedPPD = ppdSelect.value;
        const selectedSchoolName = this.value;
        if (schoolData[selectedPPD]) {
            const schoolInfo = schoolData[selectedPPD].find(s => s.name === selectedSchoolName);
            if (schoolInfo) {
                agensiInput.value = schoolInfo.agensi;
                kodSekolahInput.value = schoolInfo.kod;
                fetchAndPopulateRecord(schoolInfo.kod);
            }
        }
    });
    
    document.querySelectorAll('input[name="Status Peruntukan"]').forEach(radio => {
        radio.addEventListener('change', function() {
            receivedDetailsContainer.classList.toggle('hidden', this.value !== 'Telah Terima');
            if(this.value !== 'Telah Terima') {
                tarikhInput.value = '';
                peruntukanDibelanjakanInput.value = '';
                calculateBalance();
            }
        });
    });

    [peruntukanInput, peruntukanDibelanjakanInput].forEach(input => {
        input.addEventListener('input', (e) => {
            let value = e.target.value.replace(/[^0-9.]/g, '');
            let parts = value.split('.');
            let integerPart = parts[0];
            let decimalPart = parts.length > 1 ? '.' + parts[1].slice(0,2) : '';
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            e.target.value = integerPart + decimalPart;
            calculateBalance();
        });
    });

    allocationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menghantar...';
        formMessage.textContent = '';
        const assets = [];
        document.querySelectorAll('.asset-row').forEach(row => {
            const name = row.querySelector('.asset-name').value.trim();
            const quantity = row.querySelector('.asset-quantity').value.trim();
            if (name && quantity) assets.push({ item: name, kuantiti: quantity });
        });
        const formData = new FormData(this);
        const dataObject = {};
        formData.forEach((value, key) => dataObject[key] = value);
        
        dataObject['Peruntukan Diluluskan (RM)'] = peruntukanInput.value.replace(/,/g, '');
        dataObject['Peruntukan Dibelanjakan (RM)'] = peruntukanDibelanjakanInput.value.replace(/,/g, '');

        dataObject['Senarai Aset Peralatan'] = JSON.stringify(assets);
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataObject) })
            .then(res => res.json())
            .then(data => {
                const actionText = formActionInput.value === 'update' ? 'dikemaskini' : 'dihantar';
                if(data.result === 'success') {
                    formMessage.innerHTML = `<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md" role="alert"><p class="font-bold">Berjaya!</p><p>Laporan anda telah berjaya ${actionText}.</p></div>`;
                    setTimeout(() => {
                        allocationForm.reset();
                        sekolahSelect.innerHTML = '<option value="" disabled selected>-- Sila Pilih PPD Dahulu --</option>';
                        sekolahSelect.disabled = true;
                        clearReportDetails();
                        populatePPDDropdown(ppdSelect);
                    }, 3000);
                } else { throw new Error(data.message || 'Ralat tidak diketahui'); }
            })
            .catch(error => {
                formMessage.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert"><p class="font-bold">Ralat!</p><p>${error.message}</p></div>`;
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = formActionInput.value === 'update' ? 'Kemaskini Laporan' : 'Hantar Laporan';
            });
    });

    async function loadChecklistData() {
        const loader = document.getElementById('checklist-loader');
        const content = document.getElementById('checklist-content');
        loader.classList.remove('hidden');
        content.classList.add('hidden');
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            if (!response.ok) throw new Error('Gagal memuatkan data dari server.');
            const submittedData = await response.json();
            const submittedCodes = submittedData.map(item => item['Kod Sekolah']);
            fullChecklistData = [];
            for (const ppd in schoolData) {
                schoolData[ppd].forEach(school => {
                    fullChecklistData.push({
                        kod: school.kod, ppd: ppd, sekolah: school.name,
                        status: submittedCodes.includes(school.kod) ? 'Telah Hantar' : 'Belum Hantar'
                    });
                });
            }
            populateChecklistFilters();
            applyChecklistFiltersAndRedraw();
            loader.classList.add('hidden');
            content.classList.remove('hidden');
        } catch (error) {
            loader.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
        }
    }

    function populateChecklistFilters() {
        const ppds = Object.keys(schoolData);
        checklistFilterPPD.innerHTML = '<option value="all">Semua PPD</option>';
        ppds.forEach(ppd => {
            const option = document.createElement('option');
            option.value = ppd; option.textContent = ppd;
            checklistFilterPPD.appendChild(option);
        });
    }

    checklistFilterPPD.addEventListener('change', applyChecklistFiltersAndRedraw);
    checklistResetFiltersBtn.addEventListener('click', () => {
        checklistFilterPPD.value = 'all'; applyChecklistFiltersAndRedraw();
    });

    function applyChecklistFiltersAndRedraw() {
        let filteredData = [...fullChecklistData];
        const selectedPPD = checklistFilterPPD.value;
        if (selectedPPD !== 'all') {
            filteredData = filteredData.filter(item => item.ppd === selectedPPD);
        }
        populateChecklistTable(filteredData);
    }
    
    function populateChecklistTable(data) {
        checklistTableBody.innerHTML = '';
        if (data.length === 0) {
            checklistTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-slate-500 py-4">Tiada data.</td></tr>'; return;
        }
        data.forEach(item => {
            const row = document.createElement('tr');
            const statusClass = item.status === 'Telah Hantar' ? 'status-sent' : 'status-pending';
            row.innerHTML = `<td>${item.kod}</td><td>${item.ppd}</td><td>${item.sekolah}</td><td><span class="status-badge ${statusClass}">${item.status}</span></td>`;
            checklistTableBody.appendChild(row);
        });
    }

    // --- Analisis Data ---
    function formatAssetsForDisplay(assetString) {
        if (!assetString) return '';
        try {
            if (assetString.trim().startsWith('[')) {
                const assets = JSON.parse(assetString);
                if (Array.isArray(assets) && assets.length > 0) {
                    return assets.map(a => `${a.kuantiti}x ${a.item}`).join('\n');
                }
                return '-';
            }
            return assetString;
        } catch (e) { return assetString; }
    }

    async function loadDashboardData() {
        const loader = document.getElementById('dashboard-loader');
        const content = document.getElementById('dashboard-content');
        loader.classList.remove('hidden');
        content.classList.add('hidden');
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            if (!response.ok) throw new Error('Gagal memuatkan data dari server.');
            const allData = await response.json();
            samData = allData.filter(item => item.hasOwnProperty('Peruntukan Diluluskan (RM)'));
            populateFilters();
            applyFiltersAndRedraw();
            loader.classList.add('hidden');
            content.classList.remove('hidden');
        } catch (error) {
            loader.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
        }
    }
    
    function populateFilters() {
        const ppds = Object.keys(schoolData);
        filterPPD.innerHTML = '<option value="all">Semua PPD</option>';
        ppds.forEach(ppd => {
            const option = document.createElement('option');
            option.value = ppd; option.textContent = ppd;
            filterPPD.appendChild(option);
        });
    }

    filterPPD.addEventListener('change', () => {
        const selectedPPD = filterPPD.value;
        filterSekolah.innerHTML = '<option value="all">Semua Sekolah</option>';
        if (selectedPPD === 'all') {
            filterSekolah.disabled = true;
        } else {
            schoolData[selectedPPD].forEach(school => {
                const option = document.createElement('option');
                option.value = school.name; option.textContent = school.name;
                filterSekolah.appendChild(option);
            });
            filterSekolah.disabled = false;
        }
        applyFiltersAndRedraw();
    });

    filterSekolah.addEventListener('change', applyFiltersAndRedraw);
    resetFiltersBtn.addEventListener('click', () => {
        filterPPD.value = 'all';
        filterSekolah.innerHTML = '<option value="all">Semua Sekolah</option>';
        filterSekolah.disabled = true;
        applyFiltersAndRedraw();
    });
    
    function applyFiltersAndRedraw() {
        let filteredData = [...samData];
        const selectedPPD = filterPPD.value;
        const selectedSekolah = filterSekolah.value;
        if (selectedPPD !== 'all') filteredData = filteredData.filter(item => item.PPD === selectedPPD);
        if (selectedSekolah !== 'all') filteredData = filteredData.filter(item => item.Sekolah === selectedSekolah);
        updateDashboard(filteredData);
    }

    function updateDashboard(data) {
        const totalApproved = data.reduce((sum, item) => sum + (parseFloat(item['Peruntukan Diluluskan (RM)']) || 0), 0);
        const totalSpent = data.reduce((sum, item) => sum + (parseFloat(item['Peruntukan Dibelanjakan (RM)']) || 0), 0);
        const totalBalance = totalApproved - totalSpent;
        const percentSpent = totalApproved > 0 ? (totalSpent / totalApproved) * 100 : 0;
        
        const allocationsReceived = data.filter(item => item['Status Peruntukan'] === 'Telah Terima').length;
        
        document.getElementById('total-approved').textContent = `RM ${totalApproved.toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('total-spent').textContent = `RM ${totalSpent.toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('total-balance').textContent = `RM ${totalBalance.toLocaleString('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('total-allocations').textContent = data.length;
        document.getElementById('percent-spent').textContent = `${percentSpent.toFixed(1)}%`;
        
        populateSchoolStatusLists(data);
        updatePPDChart(data);
        updateAssetBreakdownChart(data);
        populateDataTable(data);
    }

    function populateSchoolStatusLists(data) {
        const listReceived = document.getElementById('list-received');
        const listNotReceived = document.getElementById('list-not-received');
        listReceived.innerHTML = ''; listNotReceived.innerHTML = '';
        data.forEach(item => {
            const li = document.createElement('li');
            li.className = 'text-sm text-slate-700';
            li.textContent = `${item.Sekolah} (${item.PPD})`;
            if(item['Status Peruntukan'] === 'Telah Terima') listReceived.appendChild(li);
            else listNotReceived.appendChild(li);
        });
        if(listReceived.innerHTML === '') listReceived.innerHTML = '<li class="text-sm text-slate-400">Tiada sekolah.</li>';
        if(listNotReceived.innerHTML === '') listNotReceived.innerHTML = '<li class="text-sm text-slate-400">Tiada sekolah.</li>';
    }
    
    function populateDataTable(data) {
        const tableBody = document.getElementById('data-table-body');
        tableBody.innerHTML = '';
        if(data.length === 0){ tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-slate-500 py-4">Tiada data.</td></tr>'; return; }
        data.forEach(item => {
            const row = document.createElement('tr');
            const formattedDate = item['Tarikh Terima'] ? new Date(item['Tarikh Terima']).toLocaleDateString('ms-MY') : '-';
            const approved = parseFloat(item['Peruntukan Diluluskan (RM)'] || 0);
            const spent = parseFloat(item['Peruntukan Dibelanjakan (RM)'] || 0);
            const balance = approved - spent;

            row.innerHTML = `
                <td>${item['Kod Sekolah']||''}</td>
                <td>${item.PPD||''}</td>
                <td>${item.Sekolah||''}</td>
                <td>${item.Agensi||''}</td>
                <td>${approved.toLocaleString('ms-MY')}</td>
                <td>${spent.toLocaleString('ms-MY')}</td>
                <td>${balance.toLocaleString('ms-MY')}</td>
                <td>${item['Status Peruntukan']||''}</td>
                <td>${formattedDate}</td>
                <td class="whitespace-pre-wrap">${formatAssetsForDisplay(item['Senarai Aset Peralatan'])}</td>
                <td>${item.Catatan||''}</td>`;
            tableBody.appendChild(row);
        });
    }

    function updatePPDChart(data) {
        const ctx = document.getElementById('allocation-by-ppd-chart').getContext('2d');
        const dataByPPD = data.reduce((acc, item) => {
            const ppd = item['PPD'];
            if (!acc[ppd]) { acc[ppd] = 0; }
            acc[ppd] += parseFloat(item['Peruntukan Diluluskan (RM)']) || 0;
            return acc;
        }, {});
        const labels = Object.keys(dataByPPD).sort();
        const values = labels.map(ppd => dataByPPD[ppd]);
        if (charts.ppd) charts.ppd.destroy();
        charts.ppd = new Chart(ctx, { type: 'bar', data: { labels, datasets: [ { label: 'Jumlah Peruntukan (RM)', data: values, backgroundColor: 'rgba(59, 130, 246, 0.7)' } ] }, options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
    }

    function updateAssetBreakdownChart(data) {
        const ctx = document.getElementById('asset-breakdown-chart').getContext('2d');
        const assetTotals = {};
        data.forEach(row => {
            try {
                if(row['Senarai Aset Peralatan'] && row['Senarai Aset Peralatan'].trim().startsWith('[')) {
                    const assets = JSON.parse(row['Senarai Aset Peralatan']);
                    assets.forEach(asset => {
                        const itemName = asset.item.trim();
                        const quantity = parseInt(asset.kuantiti, 10);
                        if(itemName && !isNaN(quantity)) { assetTotals[itemName] = (assetTotals[itemName] || 0) + quantity; }
                    });
                }
            } catch(e) {}
        });
        const labels = Object.keys(assetTotals).sort();
        const values = labels.map(label => assetTotals[label]);
        if (charts.asset) charts.asset.destroy();
        charts.asset = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Jumlah Kuantiti', data: values, backgroundColor: 'rgba(22, 163, 74, 0.7)' }] }, options: { indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
    }

    // Initialize
    setActivePage('allocation');
    createAssetRow();
    populatePPDDropdown(ppdSelect);
    sekolahSelect.innerHTML = '<option value="" disabled selected>-- Sila Pilih PPD Dahulu --</option>';

});
</script>

</body>
</html>

